name: Release

on:
  push:
    tags:
      - 'v*'

env:
  DOCKERHUB_IMAGE: ryops/eagle-scout
  GHCR_IMAGE: ghcr.io/ry-ops/eagle-scout

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  # ============================================
  # Build release binaries
  # ============================================
  build:
    name: Build Binaries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          - goos: windows
            goarch: amd64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          EXT=""
          if [ "$GOOS" = "windows" ]; then EXT=".exe"; fi
          CGO_ENABLED=0 go build -ldflags="-s -w -X main.version=${{ steps.version.outputs.version }}" \
            -o eagle-scout-${{ matrix.goos }}-${{ matrix.goarch }}${EXT} \
            ./cmd/eagle-scout

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: eagle-scout-${{ matrix.goos }}-${{ matrix.goarch }}
          path: eagle-scout-*

  # ============================================
  # Build and push Docker images
  # ============================================
  docker:
    name: Docker Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKERHUB_IMAGE }}
            ${{ env.GHCR_IMAGE }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: Build and Push (multi-arch)
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          provenance: mode=max
          sbom: true

      - name: Docker Scout - Release Report
        uses: docker/scout-action@v1
        with:
          command: quickview
          image: ${{ env.DOCKERHUB_IMAGE }}:${{ steps.version.outputs.version }}
          summary: true

  # ============================================
  # Create GitHub Release
  # ============================================
  release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [build, docker]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: eagle-scout-*
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          for dir in artifacts/eagle-scout-*; do
            for file in "$dir"/*; do
              cp "$file" release/
            done
          done
          cd release
          for file in eagle-scout-*; do
            sha256sum "$file" >> checksums.txt
          done

      - name: Generate release notes
        id: notes
        run: |
          cat << 'EOF' > release_notes.md
          ## Docker Images

          Pull from Docker Hub:
          ```bash
          docker pull ryops/eagle-scout:${{ steps.version.outputs.version }}
          ```

          Pull from GitHub Container Registry:
          ```bash
          docker pull ghcr.io/ry-ops/eagle-scout:${{ steps.version.outputs.version }}
          ```

          ## Binaries

          | Platform | Architecture | File |
          |----------|--------------|------|
          | Linux | amd64 | `eagle-scout-linux-amd64` |
          | Linux | arm64 | `eagle-scout-linux-arm64` |
          | macOS | amd64 | `eagle-scout-darwin-amd64` |
          | macOS | arm64 | `eagle-scout-darwin-arm64` |
          | Windows | amd64 | `eagle-scout-windows-amd64.exe` |

          ## Verification

          Verify checksums:
          ```bash
          sha256sum -c checksums.txt
          ```

          ## Changelog

          See [CHANGELOG.md](https://github.com/ry-ops/eagle-scout/blob/main/CHANGELOG.md) for details.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: eagle-scout v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            release/*
          draft: false
          prerelease: false
          generate_release_notes: true
